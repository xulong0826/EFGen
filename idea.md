# 因果驱动的分子生成框架

## 1. 核心思想：从“盲目采样”到“智能干预”

传统的分子生成方法，如强化学习，往往依赖于大规模的“盲目”蒙特卡洛采样来探索化学空间，这种方式效率低下且计算成本高昂。本框架旨在引入因果推断的思想，将分子生成过程从“广撒网”式的试错，转变为一个“精确打击”式的、由数据驱动的智能干预过程。

核心目标是：在有限的、昂贵的计算资源（`oracle` 调用）下，最高效地学习到从片段/条件（F）到分子结构（M）再到属性（P）的因果关系，并利用这种关系来引导生成器产出更优的分子。

## 2. 因果建模

我们将分子的物理生成过程抽象为一条简单的因果链：

**F (片段/条件) → M (完整分子结构) → P (分子属性)**

*   **F**: 我们的初始输入或控制变量。
*   **M**: 由 F 通过 `composer`（生成器）生成的具体分子，是因果链的直接中介。
*   **P**: 由分子结构 M 唯一决定的最终属性，是我们的优化目标。

直接优化这条链的困难在于：
1.  从 F 到 M 的映射（`p(M|F)`）可能非常复杂且是多模态的（一个 F 可以生成多种 M）。
2.  评估 P 的函数 `oracle(M)` 计算成本极高。

为了解决这个问题，我们引入一个**可观测的中介变量 M_part**，并构建一个并行的、可计算的预测模型（`surrogate`），从而实现对整个流程的智能控制。

## 3. M_part：可观测的因果中介与学习仪表盘

### 3.1 M_part 的整体意义

M_part 是我们为了理解和控制 `F -> M -> P` 这一物理因果链而构建的**可观测信息向量**。它不再仅仅是分子的一个简单描述，而是我们整个**因果学习框架的“仪表盘”**。这个仪表盘告诉我们三件核心事情：

1.  **“它是什么？”** (规则专家): 分子的客观化学结构和性质。
2.  **“我（模型）认为它是什么？”** (生成器专家): 模型对分子深层模式的理解。
3.  **“我有多大把握？”** (不确定性专家): 模型对此次判断的自信程度。

通过整合这三方面信息，M_part 将一个复杂的、高维的、离散的分子生成问题，转化为一个可度量、可预测、可优化的结构化学习问题。

### 3.2 M_part 的组件构成与理论意义

M_part 的设计遵循“专家网络”思想，每个组件由一个独立的“专家”提供信息，它们各司其职，互为补充。

#### 规则专家 (Rule Features) - *终态计算*
*   **组件**: Morgan 指纹、RDKit 分子描述符 (LogP, TPSA 等)。
*   **理论意义：化学世界的“公理”和“基石”**。这部分特征是基于数十年化学知识沉淀下来的、公认的结构-属性关系描述符。它们是**可解释的、稳定的、模型无关的**，构成了我们属性预测的强大基线和“事实锚点”。

#### 生成器专家 (Generator Features) - *实时/终态计算*
*   **组件**: 生成器（Transformer）的池化表征向量 (`pooled_repr`)。
*   **理论意义：机器学习世界的“语感”和“洞察”**。如果说规则特征是分子的“语法”，那么 `repr` 就是模型在阅读了海量分子后形成的“语感”。它捕捉了规则特征难以描述的、隐式的、非线性的化学环境和结构模式，代表了生成器对“一个好分子应该长什么样”的**内部信念**。

#### 不确定性专家 (Uncertainty Features) - *采样时计算*
*   **组件**: 认知不确定性 (`epistemic_std`，通过 MC Dropout 计算)、样本计数 (`count`)。
*   **理论意义：科学探索过程中的“指南针”和“风险计”**。这部分特征不描述分子本身，而是描述我们**对该分子属性的知识状态**。它指导我们将有限的、昂贵的干预（`oracle` 调用）预算，投放到信息收益最高的地方（即模型最“没把握”的地方），是**主动学习 (Active Learning)** 的核心驱动力。

## 4. M_part 如何介入并引导分子生成：智能闭环流程

M_part 通过一个**“生成 → 评估 → 决策 → 学习”**的智能闭环来引导整个流程。

```
+-----------------+      +----------------------+      +-------------------+
|    Generator    | ---> | M_part Extraction    | ---> | Surrogate Model   |
| (生成 SMILES)   |      | (提取规则/生成器/不确定性特征) |      | (快速预测 P_hat)  |
+-----------------+      +----------------------+      +-------------------+
       ^                                                       |
       |                                                       v
+-----------------+      +----------------------+      +-------------------+
| Model Update    | <--- | RewardBuffer         | <--- | Decision Logic    |
| (更新 Gen/Surr) |      | (存储高质量训练数据)   |      | (调用 Oracle?)    |
+-----------------+      +----------------------+      +-------------------+
```

### 步骤详解：

1.  **生成 (Generation)**: `GenSampler` 生成一批分子 SMILES。
2.  **评估与信息提取 (Evaluation & Feature Extraction)**: 对每个生成的 SMILES，并行计算其**规则特征**、**生成器特征**和**不确定性特征**，组装成一个完整的 M_part 字典。
3.  **决策与干预 (Decision & Intervention)**:
    *   将 M_part 输入到预训练好的 `Surrogate` 模型中，进行快速、廉价的属性预测 (`P_hat`)。
    *   基于 `P_hat` 和不确定性进行决策：对高预测、高不确定性的“潜力股”**调用昂贵的 `oracle`** 进行精确评估；对低预测的直接丢弃。
4.  **学习与更新 (Learning & Updating)**:
    *   凡是经过 `oracle` 评估的样本，其 `(SMILES, oracle_reward, M_part)` 作为一个高质量的训练数据点，被存入结构化的 `RewardBuffer`。
    *   定期从 `RewardBuffer` 中抽取数据，增量更新 `Surrogate` 模型和 `Generator` 模型。

通过这个闭环，M_part 确保了每一次昂贵的计算都用在“刀刃上”，从而以最高的效率引导系统向着生成更优分子的目标进化。

## 5. 关键组件的角色演进

在新框架下，一些传统组件的角色得到了升级和重新定义：

*   **MC Dropout**: 不再仅仅是增加探索的工具，而是升级为**不确定性专家**的核心，其主要任务是量化**认知不确定性**，为主动学习提供关键指引。
*   **经验池 (RewardBuffer)**: 不再是简单的 `(smiles, reward)` 缓存，而是升级为**结构化因果数据库**，存储了从 F 到 M 到 M_part 到 P 的完整链条信息，是整个学习系统的“大脑记忆中枢”。
*   **蒙特卡洛采样 (MC Sampling)**: 不再是“广撒网”的蛮力方法，而是升级为在关键点（如高不确定性区域）进行“精确打击”的**智能探索工具**，用于估计多模态不确定性或为 IS/DR 等高级因果估计方法提供样本。


---

### M_part 的组成、意义、求法与使用时机（补充说明）

#### 1. 规则专家（Rule Features）
- **意义**：分子的客观结构和基础性质，是可解释、稳定的“事实锚点”。
- **求法**：每次分子生成后，立即用 RDKit 计算 Morgan 指纹（如 2048 维）和描述符（如 LogP、TPSA、MolWt），拼接为一维向量。
- **使用时机**：每个 SMILES 生成后，作为 M_part 的一部分输入 Surrogate。

#### 2. 生成器专家（Generator Features, repr）
- **意义**：反映生成器模型对分子的“语感”和深层结构理解，是模型的隐式信念。
- **求法**：分子生成完成后，对完整序列做一次 forward，取 Transformer 编码器输出的池化表征（如 mean pooling 得到 [d_model] 维向量）。
- **使用时机**：
    - 每个 SMILES 生成后，立即计算 pooled_repr。
    - 与规则特征拼接，作为 M_part 输入 Surrogate。
    - 用于主动学习、因果推断等分析模型信念。

#### 3. 不确定性专家（Uncertainty Features）
- **意义**：反映模型对分子属性预测的信心，是主动学习和智能干预的核心指标。
- **求法**：对每个 M_part，Surrogate 用 MC Dropout 多次预测，统计均值和标准差（epistemic_std），并记录样本计数（count）。
- **使用时机**：
    - 决策环节，用 UCB/EI 等策略优先选择高不确定性分子调用 oracle。
    - RewardBuffer 记录，用于后续模型更新。

#### 4. M_part 的整体流程与 repr 的作用

1. **分子生成**：`GenSampler` 生成 SMILES，立即计算规则特征和 pooled_repr。
2. **M_part 构建**：拼接规则特征和 pooled_repr，形成 M_part，输入 Surrogate。
3. **不确定性评估**：Surrogate 用 MC Dropout 多次预测，得到均值和方差。
4. **决策与干预**：用 M_part 的属性预测和不确定性，计算 UCB/EI 分数，选出高分子调用 oracle。
5. **RewardBuffer 记录与模型更新**：每次 oracle 评估后，将 (SMILES, oracle_reward, M_part, 不确定性) 存入 RewardBuffer，定期用数据增量训练 Surrogate 和 Generator。

**repr 的核心作用**：  
repr 是生成器对分子的深层理解，是 M_part 的重要组成之一。每次分子生成后立即计算，与规则特征一起作为 Surrogate 输入，让属性预测和因果推断能捕捉复杂结构信息。repr 只在分子生成完成后、M_part 构建时计算一次，不在采样循环中反复收集。

---